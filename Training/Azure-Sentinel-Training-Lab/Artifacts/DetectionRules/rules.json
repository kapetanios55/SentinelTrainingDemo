[
  {
    "displayName": "Lab Stage 2 Malicious Payload Execution (CrowdStrike)",
    "isEnabled": true,
    "queryCondition": {
      "queryText": "CrowdStrikeDetections\n| where TimeGenerated > ago(1h)\n| where Tactic == \"Execution\" or Technique has \"T1204\"\n| where SeverityName in (\"High\", \"Critical\")\n| project\n    TimeGenerated,\n    Name,\n    Description,\n    SeverityName,\n    Tactic,\n    Technique,\n    UserName,\n    SourceAccountUpn,\n    Filename,\n    Filepath,\n    Sha256,\n    Md5,\n    Cmdline,\n    Device\n| extend\n    AccountUpn = SourceAccountUpn,\n    DeviceName = tostring(Device.hostname),\n    ReportId = tostring(hash_sha256(strcat(tostring(TimeGenerated), Name, tostring(Device.hostname))))"
    },
    "schedule": {
      "period": "1H"
    },
    "detectionAction": {
      "alertTemplate": {
        "title": "Lab Stage 2 Malicious payload execution detected by CrowdStrike",
        "description": "CrowdStrike detected a high or critical severity execution event on an endpoint. Stage 2 of the Lab attack chain (T1204.002).",
        "severity": "high",
        "category": "Execution",
        "mitreTechniques": ["T1204.002"],
        "recommendedActions": null,
        "impactedAssets": [
          {
            "@odata.type": "#microsoft.graph.security.impactedDeviceAsset",
            "identifier": "deviceName"
          },
          {
            "@odata.type": "#microsoft.graph.security.impactedUserAsset",
            "identifier": "accountUpn"
          }
        ]
      },
      "organizationalScope": null,
      "responseActions": []
    }
  },
  {
    "displayName": "Lab Stage 3 Credential Dumping Detected (CrowdStrike)",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "CrowdStrikeDetections\n| where TimeGenerated > ago(1h)\n| where Tactic == \"Credential Access\" or Technique has \"T1003\"\n| where SeverityName in (\"High\", \"Critical\")\n| project\n    TimeGenerated,\n    Name,\n    Description,\n    SeverityName,\n    Tactic,\n    Technique,\n    UserName,\n    SourceAccountUpn,\n    Filename,\n    Filepath,\n    Cmdline,\n    Objective,\n    Device\n| extend\n    AccountUpn = SourceAccountUpn,\n    DeviceName = tostring(Device.hostname),\n    ReportId = tostring(hash_sha256(strcat(tostring(TimeGenerated), Name, tostring(Device.hostname))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 3 - Credential dumping detected by CrowdStrike",
            "description": "CrowdStrike detected credential dumping activity on an endpoint. Stage 3 of the Lab attack chain (T1003.001).",
            "severity": "high",
            "category": "CredentialAccess",
            "mitreTechniques": ["T1003.001"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedDeviceAsset",
                    "identifier": "deviceName"
                },
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
  },
{
    "displayName": "Lab Stage 3.5 Internal Port Scan Detected (Palo Alto)",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "CommonSecurityLog\n| where TimeGenerated > ago(1h)\n| where DeviceVendor == \"Palo Alto Networks\"\n| where DeviceEventClassID == \"TRAFFIC\"\n| where Activity in (\"drop\", \"deny\", \"end\")\n| where ApplicationProtocol == \"incomplete\"\n| summarize\n    DistinctPorts = dcount(DestinationPort),\n    DistinctHosts = dcount(DestinationIP),\n    SessionCount = count(),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated),\n    SourceHostName = take_any(SourceHostName)\n    by SourceIP, SourceUserName\n| where DistinctPorts > 20\n| extend\n    TimeGenerated = FirstSeen,\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    ReportId = tostring(hash_sha256(strcat(SourceIP, SourceUserName, tostring(DistinctPorts))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 3.5 - Internal port scan detected via Palo Alto",
            "description": "A host scanned more than 20 distinct ports across internal hosts, indicating network reconnaissance. Stage 3.5 of the Lab attack chain (T1046).",
            "severity": "medium",
            "category": "Discovery",
            "mitreTechniques": ["T1046"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedDeviceAsset",
                    "identifier": "deviceName"
                },
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
 },
 {
    "displayName": "Lab Stage 4 -Account Takeover Chain",
    "description": "Detects a suspicious Okta login from a foreign country followed by privilege escalation within 15 minutes. To add markUserAsCompromised response action: join IdentityInfo on AccountUPN to resolve AccountObjectId (requires Defender for Identity).",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "let login_events = OktaV2_CL\n| where TimeGenerated > ago(4h)\n| where EventOriginalType == \"user.session.start\"\n| where OriginalOutcomeResult == \"SUCCESS\"\n| where SrcGeoCountry != \"AU\"\n| project LoginTime = TimeGenerated, ActorUsername, SrcIpAddr, SrcGeoCountry, SrcGeoCity, ActorSessionId;\nlet priv_events = OktaV2_CL\n| where TimeGenerated > ago(4h)\n| where EventOriginalType in (\"user.account.privilege.grant\", \"system.api_token.create\", \"user.session.impersonation.grant\", \"user.mfa.factor.deactivate\")\n| where OriginalOutcomeResult == \"SUCCESS\"\n| project PrivTime = TimeGenerated, ActorUsername, EventOriginalType, EventMessage, SrcIpAddr;\nlogin_events\n| join kind=inner priv_events on ActorUsername, SrcIpAddr\n| where PrivTime between (LoginTime .. LoginTime + 15m)\n| project\n    LoginTime,\n    PrivTime,\n    ActorUsername,\n    SrcIpAddr,\n    SrcGeoCountry,\n    SrcGeoCity,\n    PrivilegeAction = EventOriginalType,\n    ActionMessage = EventMessage\n| extend\n    TimeGenerated = LoginTime,\n    AccountUpn = ActorUsername,\n    RemoteIP = SrcIpAddr,\n    AppName = \"Okta\"\n| extend ReportId = tostring(hash_sha256(strcat(tostring(LoginTime), ActorUsername, SrcIpAddr)))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Account takeover by {{ActorUsername}} from {{SrcGeoCountry}} [Okta]",
            "description": "An Okta user logged in from a foreign location and performed privilege escalation within 15 minutes (T1078.004 + T1098). This pattern is consistent with compromised credentials used for post-compromise activity.",
            "severity": "high",
            "category": "PrivilegeEscalation",
            "mitreTechniques": ["T1078.004", "T1098"],
            "recommendedActions": "Immediately suspend the user account. Revoke all active sessions. Reset credentials and MFA. Investigate the foreign IP address.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab Stage 6 Large Data Exfiltration (Palo Alto)",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "CommonSecurityLog\n| where TimeGenerated > ago(1h)\n| where DeviceVendor == \"Palo Alto Networks\"\n| where DeviceEventClassID == \"TRAFFIC\"\n| where Activity == \"end\"\n| where isnotempty(DestinationIP)\n| where ipv4_is_private(DestinationIP) == false\n| where SentBytes > 10000000\n| project\n    TimeGenerated,\n    SourceIP,\n    DestinationIP,\n    DestinationPort,\n    SentBytes,\n    ReceivedBytes,\n    ApplicationProtocol,\n    SourceUserName,\n    SourceHostName,\n    DeviceAction\n| extend\n    SentMB = round(SentBytes / 1048576.0, 2),\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    ReportId = tostring(hash_sha256(strcat(tostring(TimeGenerated), SourceIP, DestinationIP, tostring(SentBytes))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 6 - Large data exfiltration to external IP",
            "description": "Palo Alto firewall detected a session sending more than 10 MB to an external IP. This indicates potential data exfiltration. Stage 6 of the Lab attack chain (T1041).",
            "severity": "high",
            "category": "Exfiltration",
            "mitreTechniques": ["T1041"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedDeviceAsset",
                    "identifier": "deviceName"
                },
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab Stage 7 AWS IAM Escalation and Suspicious Cloud Activity",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "let suspicious_events = dynamic([\n    \"ConsoleLogin\",\n    \"CreateUser\",\n    \"AttachUserPolicy\",\n    \"AuthorizeSecurityGroupIngress\",\n    \"RunInstances\",\n    \"GetObject\",\n    \"StopLogging\"\n]);\nAWSCloudTrail\n| where TimeGenerated > ago(2h)\n| where EventName in (suspicious_events)\n| summarize\n    EventSequence = make_set(EventName),\n    EventCount = count(),\n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated),\n    SourceIPs = make_set(SourceIpAddress),\n    UserArn = take_any(UserIdentityArn)\n    by UserIdentityUserName\n| where EventCount >= 3\n| where set_has_element(EventSequence, \"CreateUser\") or set_has_element(EventSequence, \"AttachUserPolicy\") or set_has_element(EventSequence, \"StopLogging\")\n| extend DurationMin = datetime_diff('minute', LastEvent, FirstEvent)\n| project\n    FirstEvent,\n    LastEvent,\n    DurationMin,\n    UserIdentityUserName,\n    EventSequence,\n    EventCount,\n    SourceIPs,\n    UserArn\n| extend\n    TimeGenerated = FirstEvent,\n    AccountUpn = strcat(UserIdentityUserName, \"@pkwork.onmicrosoft.com\"),\n    RemoteIP = tostring(SourceIPs[0]),\n    ReportId = tostring(hash_sha256(strcat(UserIdentityUserName, tostring(EventCount), tostring(FirstEvent))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 7 - AWS IAM escalation and suspicious cloud activity",
            "description": "An AWS IAM user performed multiple suspicious actions including account creation, policy attachment, or disabling CloudTrail. Stage 7 of the Lab attack chain (T1078, T1098, T1496, T1562.008).",
            "severity": "high",
            "category": "Impact",
            "mitreTechniques": ["T1078", "T1098", "T1496", "T1562.008"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab Stage 8 AWS Backdoor Account Login from Creator IP",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "let account_creations = AWSCloudTrail\n| where TimeGenerated > ago(2h)\n| where EventName == \"CreateUser\"\n| extend CreatedUser = tostring(parse_json(RequestParameters).userName)\n| project CreationTime = TimeGenerated, CreatorUser = UserIdentityUserName, CreatedUser, CreatorIP = SourceIpAddress, UserIdentityArn;\nlet new_user_logins = AWSCloudTrail\n| where TimeGenerated > ago(2h)\n| where EventName == \"ConsoleLogin\"\n| where tostring(parse_json(ResponseElements).ConsoleLogin) == \"Success\"\n| project LoginTime = TimeGenerated, LoginUser = UserIdentityUserName, LoginIP = SourceIpAddress;\naccount_creations\n| join kind=inner new_user_logins on $left.CreatedUser == $right.LoginUser\n| where LoginIP == CreatorIP\n| where LoginTime > CreationTime\n| project\n    CreationTime,\n    LoginTime,\n    CreatorUser,\n    CreatedUser,\n    SharedIP = CreatorIP,\n    UserIdentityArn\n| extend\n    TimeGenerated = LoginTime,\n    AccountUpn = strcat(CreatorUser, \"@pkwork.onmicrosoft.com\"),\n    RemoteIP = SharedIP,\n    ReportId = tostring(hash_sha256(strcat(CreatorUser, CreatedUser, SharedIP, tostring(LoginTime))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 8 - AWS backdoor account logged in from creator IP",
            "description": "A newly created IAM user logged into the AWS console from the same IP address used by the account that created it. This is a strong indicator of persistence via a backdoor account. Stage 8 of the Lab attack chain (T1136.003, T1078.004).",
            "severity": "high",
            "category": "Persistence",
            "mitreTechniques": ["T1136.003", "T1078.004"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab Stage 9 GCP IAM Privilege Escalation and Resource Abuse",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "let suspicious_methods = dynamic([\n    \"google.iam.admin.v1.CreateServiceAccount\",\n    \"google.iam.admin.v1.CreateServiceAccountKey\",\n    \"SetIamPolicy\",\n    \"v1.compute.firewalls.insert\",\n    \"v1.compute.instances.insert\",\n    \"google.logging.v2.ConfigServiceV2.DeleteSink\",\n    \"google.logging.v2.ConfigServiceV2.UpdateSink\"\n]);\nGCPAuditLogs\n| where TimeGenerated > ago(2h)\n| where MethodName in (suspicious_methods) or MethodName has_any (\"SetIamPolicy\", \"DeleteSink\", \"UpdateSink\")\n| extend CallerIp = tostring(parse_json(RequestMetadata).callerIp)\n| where CallerIp !startswith \"10.\" and CallerIp !startswith \"192.168.\"\n| summarize\n    EventSequence = make_set(MethodName),\n    EventCount = count(),\n    FirstEvent = min(TimeGenerated),\n    LastEvent = max(TimeGenerated),\n    SourceIPs = make_set(CallerIp),\n    TargetResources = make_set(GCPResourceName)\n    by PrincipalEmail, ProjectId\n| where EventCount >= 3\n| where set_has_element(EventSequence, \"google.iam.admin.v1.CreateServiceAccount\") or set_has_element(EventSequence, \"SetIamPolicy\") or EventSequence has \"DeleteSink\" or EventSequence has \"UpdateSink\"\n| extend DurationMin = datetime_diff('minute', LastEvent, FirstEvent)\n| project\n    FirstEvent,\n    LastEvent,\n    DurationMin,\n    PrincipalEmail,\n    ProjectId,\n    EventSequence,\n    EventCount,\n    SourceIPs,\n    TargetResources\n| extend\n    TimeGenerated = FirstEvent,\n    AccountUpn = PrincipalEmail,\n    RemoteIP = tostring(SourceIPs[0]),\n    ReportId = tostring(hash_sha256(strcat(PrincipalEmail, ProjectId, tostring(EventCount), tostring(FirstEvent))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 9 - GCP IAM privilege escalation and resource abuse",
            "description": "A GCP principal created service accounts, modified IAM policies, opened firewall rules, spun up compute instances, or disabled logging sinks from an external IP. Stage 9 of the Lab attack chain (T1136.003, T1098, T1496, T1562.008).",
            "severity": "high",
            "category": "PrivilegeEscalation",
            "mitreTechniques": ["T1136.003", "T1098", "T1496", "T1562.008"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab Stage 10 Phishing Emails Bypassing MailGuard365",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "MailGuard365_Threats_CL\n| where TimeGenerated > ago(1h)\n| where ThreatVerdict == \"Phishing\" and Action == \"Allow\"\n| where toint(ThreatConfidence) >= 80\n| extend SenderDomainLower = tolower(SenderDomain)\n| summarize\n    PhishCount = count(),\n    Subjects = make_set(Subject),\n    TargetRecipients = make_set(RecipientAddress),\n    SenderAddresses = make_set(SenderAddress),\n    SenderIPs = make_set(SenderIP),\n    AvgConfidence = avg(toint(ThreatConfidence)),\n    MaliciousUrls = make_set(Urls),\n    MaliciousAttachments = make_set(AttachmentName),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SenderDomainLower\n| where PhishCount >= 2\n| project\n    FirstSeen,\n    LastSeen,\n    SenderDomainLower,\n    PhishCount,\n    AvgConfidence,\n    SenderAddresses,\n    SenderIPs,\n    TargetRecipients,\n    Subjects,\n    MaliciousUrls,\n    MaliciousAttachments\n| extend\n    TimeGenerated = FirstSeen,\n    AccountUpn = \"mirage@pkwork.onmicrosoft.com\",\n    RemoteIP = tostring(SenderIPs[0]),\n    ReportId = tostring(hash_sha256(strcat(SenderDomainLower, tostring(PhishCount), tostring(FirstSeen))))"
    },
    "schedule": {
        "period": "1H"
    },
    "detectionAction": {
        "alertTemplate": {
            "title": "Lab Stage 10 - Phishing campaign bypassed MailGuard365 email filtering",
            "description": "Multiple phishing emails from the same sender domain were allowed through to recipient mailboxes despite high-confidence phishing verdicts from MailGuard365. Stage 10 of the Lab attack chain (T1566.001, T1566.002).",
            "severity": "high",
            "category": "InitialAccess",
            "mitreTechniques": ["T1566.001", "T1566.002"],
            "recommendedActions": null,
            "impactedAssets": [
                {
                    "@odata.type": "#microsoft.graph.security.impactedUserAsset",
                    "identifier": "accountUpn"
                }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E1] [Threat Intel] IOC Match Across Sources",
    "description": "EXERCISE: Cross-source threat intelligence correlation. This rule matches known IOC IP addresses and file hashes from the Lab attack scenario against all five data sources using a union query. Students should review the IOC values embedded in the query and understand how IOC matching works across heterogeneous log formats.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "let ioc_ips = dynamic([\"198.51.100.42\", \"203.0.113.77\", \"192.0.2.100\"]);\nlet ioc_hashes = dynamic([\"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855\"]);\nunion\n    (CommonSecurityLog\n    | where TimeGenerated > ago(4h)\n    | where DeviceVendor == \"Palo Alto Networks\"\n    | where SourceIP in (ioc_ips) or DestinationIP in (ioc_ips)\n    | extend MatchedIOC = iff(DestinationIP in (ioc_ips), DestinationIP, SourceIP)\n    | project TimeGenerated, DataSource = \"PaloAlto\", MatchedIOC, IOCType = \"ip\", Activity, SourceUserName, SourceHostName),\n    (AWSCloudTrail\n    | where TimeGenerated > ago(4h)\n    | where SourceIpAddress in (ioc_ips)\n    | project TimeGenerated, DataSource = \"AWS\", MatchedIOC = SourceIpAddress, IOCType = \"ip\", Activity = EventName, SourceUserName = UserIdentityUserName, SourceHostName = \"\"),\n    (OktaV2_CL\n    | where TimeGenerated > ago(4h)\n    | where SrcIpAddr in (ioc_ips)\n    | project TimeGenerated, DataSource = \"Okta\", MatchedIOC = SrcIpAddr, IOCType = \"ip\", Activity = EventOriginalType, SourceUserName = ActorUsername, SourceHostName = \"\"),\n    (MailGuard365_Threats_CL\n    | where TimeGenerated > ago(4h)\n    | where SenderIP in (ioc_ips)\n    | project TimeGenerated, DataSource = \"MailGuard\", MatchedIOC = SenderIP, IOCType = \"ip\", Activity = \"Phishing Email\", SourceUserName = \"mirage@pkwork.onmicrosoft.com\", SourceHostName = \"\"),\n    (CrowdStrikeDetections\n    | where TimeGenerated > ago(4h)\n    | where Sha256 in (ioc_hashes) or tostring(Device.external_ip) in (ioc_ips)\n    | extend MatchedIOC = iff(Sha256 in (ioc_hashes), Sha256, tostring(Device.external_ip))\n    | extend IOCType = iff(Sha256 in (ioc_hashes), \"hash\", \"ip\")\n    | project TimeGenerated, DataSource = \"CrowdStrike\", MatchedIOC, IOCType, Activity = Name, SourceUserName = SourceAccountUpn, SourceHostName = tostring(Device.hostname))\n| extend\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    RemoteIP = iff(IOCType == \"ip\", MatchedIOC, \"\"),\n    SHA256 = iff(IOCType == \"hash\", MatchedIOC, \"\"),\n    ReportId = tostring(hash_sha256(strcat(DataSource, MatchedIOC, tostring(TimeGenerated))))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "IOC match in {{DataSource}} — {{MatchedIOC}} [Threat Intel]",
            "description": "A known indicator of compromise (IP address or file hash) from the Lab threat intelligence feed was observed in one or more data sources.",
            "severity": "high",
            "category": "InitialAccess",
            "mitreTechniques": ["T1566"],
            "recommendedActions": "Investigate the matched IOC. Determine the source and scope of exposure. Cross-reference with the attack timeline in the Lab scenario.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E2] [Palo Alto] Port Scan Detection",
    "description": "EXERCISE: Detects network port scanning activity from Palo Alto firewall logs. Identifies hosts scanning more than 20 unique ports against a single destination, using dropped/denied connections with incomplete application protocol as indicators. Students should tune the threshold and time window.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "CommonSecurityLog\n| where TimeGenerated > ago(4h)\n| where DeviceVendor == \"Palo Alto Networks\"\n| where DeviceEventClassID == \"TRAFFIC\"\n| where Activity in (\"drop\", \"deny\", \"reset-both\")\n| where ApplicationProtocol == \"incomplete\"\n| summarize\n    DistinctPorts = dcount(DestinationPort),\n    PortList = make_set(DestinationPort, 25),\n    EventCount = count(),\n    FirstSeen = min(TimeGenerated),\n    LastSeen = max(TimeGenerated)\n    by SourceIP, DestinationIP, SourceHostName, SourceUserName\n| where DistinctPorts > 20\n| project\n    FirstSeen,\n    LastSeen,\n    SourceIP,\n    DestinationIP,\n    DistinctPorts,\n    PortList,\n    EventCount,\n    SourceHostName,\n    SourceUserName\n| extend\n    TimeGenerated = FirstSeen,\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    RemoteIP = DestinationIP,\n    ReportId = tostring(hash_sha256(strcat(SourceIP, DestinationIP, tostring(DistinctPorts))))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Port scan from {{DeviceName}} — {{DistinctPorts}} ports [Palo Alto]",
            "description": "An internal host scanned more than 20 unique ports on a single destination, indicated by dropped/denied connections with incomplete application protocol. This is consistent with reconnaissance activity (T1046).",
            "severity": "medium",
            "category": "Discovery",
            "mitreTechniques": ["T1046"],
            "recommendedActions": "Investigate the source host for compromise. Check if the destination is a legitimate service. Review recent endpoint detection alerts for the source host.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedDeviceAsset", "identifier": "deviceName" },
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E3] [Okta] MFA Factor Manipulation",
    "description": "EXERCISE: Detects Okta MFA factor deactivation, reset, or modification events. Requires re-ingestion of attack data to include the MFA deactivation event (added to the attack scenario generator after the initial data was ingested). Students should enable this rule after running a fresh attack simulation.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "OktaV2_CL\n| where TimeGenerated > ago(4h)\n| where EventOriginalType in (\"user.mfa.factor.deactivate\", \"user.mfa.factor.reset_all\", \"user.mfa.factor.update\")\n| where OriginalOutcomeResult == \"SUCCESS\"\n| project\n    TimeGenerated,\n    ActorUsername,\n    SrcIpAddr,\n    SrcGeoCountry,\n    SrcGeoCity,\n    EventOriginalType,\n    EventMessage\n| extend\n    AccountUpn = ActorUsername,\n    RemoteIP = SrcIpAddr,\n    ReportId = tostring(hash_sha256(strcat(ActorUsername, EventOriginalType, tostring(TimeGenerated))))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "MFA factor manipulation by {{ActorUsername}} [Okta]",
            "description": "An Okta user's MFA factor was deactivated, reset, or modified. This may indicate credential compromise followed by MFA bypass (T1556.006).",
            "severity": "high",
            "category": "CredentialAccess",
            "mitreTechniques": ["T1556.006"],
            "recommendedActions": "Verify the MFA change was authorized. Suspend the user account if unauthorized. Re-enroll MFA factors. Investigate the source IP for other suspicious activity.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "[S8] [Palo Alto] Data Lake Promoted Threat",
    "description": "Detects promoted threat intelligence from the Sentinel data lake KQL job output table. The PaloAlto_ThreatSummary_KQL_CL table is populated by the scheduled KQL job (datalake/kql_job_firewall_threats.json) that aggregates firewall threat and traffic data from the data lake tier. Demonstrates the data-lake-to-analytics promotion detection pattern.",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "PaloAlto_ThreatSummary_KQL_CL\n| where TimeGenerated > ago(4h)\n| where TotalSessions > 5\n    or set_has_element(todynamic(ThreatCategories), \"spyware\")\n    or set_has_element(todynamic(ThreatCategories), \"wildfire-virus\")\n    or tolong(TotalBytesSent) > 50000000\n| project\n    TimeGenerated,\n    SourceIP,\n    DestinationIP,\n    TotalSessions,\n    TotalBytesSent,\n    TotalBytesReceived,\n    ThreatCategories,\n    TopActions,\n    DistinctPorts,\n    FirstSeen,\n    LastSeen,\n    SourceUserName,\n    SourceHostName\n| extend\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    RemoteIP = DestinationIP,\n    ReportId = tostring(hash_sha256(strcat(SourceIP, DestinationIP, tostring(TotalSessions))))"
    },
    "schedule": { "period": "3H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Promoted threat summary — {{SourceIP}} to {{DestinationIP}} [Palo Alto + Data Lake]",
            "description": "The data lake KQL job identified suspicious aggregated firewall activity including threat categories or high-volume transfers. This alert is generated from promoted data lake intelligence.",
            "severity": "medium",
            "category": "CommandAndControl",
            "mitreTechniques": ["T1071.001"],
            "recommendedActions": "Review the threat categories and high-volume transfers. Investigate the source and destination IPs. Check the Palo Alto investigation notebook for detailed analysis.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedDeviceAsset", "identifier": "deviceName" },
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E4] [AWS] Console Login Without MFA",
    "description": "EXERCISE: Detect AWS console logins without MFA, enriched with a watchlist join. Students should create a BusinessCriticalAWS watchlist CSV (columns: EventSource, ServiceName, Criticality) and modify the query to join _GetWatchlist('BusinessCriticalAWS') to flag whether the login affected a critical AWS service. This demonstrates watchlist integration in custom detections.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "AWSCloudTrail\n| where TimeGenerated > ago(4h)\n| where EventName == \"ConsoleLogin\"\n| where SessionMfaAuthenticated != \"true\"\n| project\n    TimeGenerated,\n    UserIdentityUserName,\n    SourceIpAddress,\n    AWSRegion,\n    EventName,\n    MfaAuthenticated = SessionMfaAuthenticated,\n    UserIdentityArn\n| extend\n    AccountUpn = strcat(UserIdentityUserName, \"@pkwork.onmicrosoft.com\"),\n    RemoteIP = SourceIpAddress,\n    ReportId = tostring(hash_sha256(strcat(UserIdentityUserName, SourceIpAddress, tostring(TimeGenerated))))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Console login without MFA by {{UserIdentityUserName}} [AWS]",
            "description": "An AWS console login was detected without MFA authentication. This is a high-risk configuration that may indicate compromised credentials (T1078.004).",
            "severity": "medium",
            "category": "InitialAccess",
            "mitreTechniques": ["T1078.004"],
            "recommendedActions": "Enforce MFA on the IAM user. Review recent API activity for the user. Check if the login is from an expected IP and region.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E5] [CrowdStrike] Device Isolation Response",
    "description": "EXERCISE: Detects critical CrowdStrike alerts and resolves the MDE DeviceId via a DeviceInfo join to enable automatic device isolation. Students should start with the base query (no join), add the DeviceInfo join, then configure the isolateDevice response action. Requires a VM onboarded to MDE.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "CrowdStrikeDetections\n| where TimeGenerated > ago(4h)\n| where SeverityName == \"Critical\"\n| extend CSHostname = tostring(Device.hostname)\n| join kind=inner (\n    DeviceInfo\n    | where Timestamp > ago(14d)\n    | summarize arg_max(Timestamp, DeviceId) by DeviceName\n    | project DeviceName, DeviceId\n) on $left.CSHostname == $right.DeviceName\n| project\n    TimeGenerated,\n    Name,\n    Description,\n    SeverityName,\n    Tactic,\n    Technique,\n    TechniqueId,\n    SourceAccountUpn,\n    CSHostname,\n    DeviceId,\n    Filename,\n    Sha256,\n    Cmdline\n| extend\n    AccountUpn = SourceAccountUpn,\n    DeviceName = CSHostname,\n    FileName = Filename,\n    SHA256 = Sha256,\n    ProcessCommandLine = Cmdline,\n    ReportId = tostring(hash_sha256(strcat(tostring(TimeGenerated), Name, CSHostname)))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Critical CrowdStrike detection on {{DeviceName}} — isolation ready [E5]",
            "description": "A critical CrowdStrike detection was observed and the device was resolved to an MDE DeviceId for automated isolation. Exercise 5 demonstrates cross-platform response actions (T1204.002).",
            "severity": "high",
            "category": "Execution",
            "mitreTechniques": ["T1204.002"],
            "recommendedActions": "Verify the device is correctly identified. Check Action Center for the isolation status. Release the device after investigation.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedDeviceAsset", "identifier": "deviceId" },
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "Lab [E7] [Palo Alto] Data Lake Port Diversity Anomaly",
    "description": "EXERCISE: Detects port scanning patterns from the pre-aggregated data lake table PaloAlto_ThreatSummary_KQL_CL. Compares data lake detection with the real-time approach in E2. Uses a 3-hour schedule aligned with data lake batch processing intervals. Requires Exercise 6 (KQL Jobs) to be completed first.",
    "isEnabled": false,
    "queryCondition": {
        "queryText": "PaloAlto_ThreatSummary_KQL_CL\n| where TimeGenerated > ago(12h)\n| where DistinctPorts > 10\n| project\n    TimeGenerated,\n    SourceIP,\n    DestinationIP,\n    DistinctPorts,\n    TotalSessions,\n    TotalBytesSent,\n    TotalBytesReceived,\n    ThreatCategories,\n    TopActions,\n    FirstSeen,\n    LastSeen,\n    SourceUserName,\n    SourceHostName\n| extend\n    AccountUpn = SourceUserName,\n    DeviceName = SourceHostName,\n    RemoteIP = DestinationIP,\n    ReportId = tostring(hash_sha256(strcat(SourceIP, DestinationIP, tostring(DistinctPorts), tostring(TimeGenerated))))"
    },
    "schedule": { "period": "3H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Port diversity anomaly — {{SourceIP}} scanning {{DistinctPorts}} ports [Data Lake]",
            "description": "The data lake aggregated table detected a source IP communicating with an unusual number of destination ports, consistent with reconnaissance activity (T1046). This detection uses pre-aggregated data from the KQL job output.",
            "severity": "medium",
            "category": "Discovery",
            "mitreTechniques": ["T1046"],
            "recommendedActions": "Compare with real-time E2 alerts. Investigate the source host for compromise. Review the ThreatCategories for additional context.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedDeviceAsset", "identifier": "deviceName" },
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
},
{
    "displayName": "[S1] [MailGuard] Phishing Email Delivered",
    "description": "Detects phishing emails that passed through MailGuard SEG and were delivered to an internal recipient. Maps Mailbox, Account, IP, URL, and File entities for the incident graph.",
    "isEnabled": true,
    "queryCondition": {
        "queryText": "SEG_MailGuard_CL\n| where TimeGenerated > ago(4h)\n| where ThreatVerdict in (\"Phishing\", \"Malicious\")\n| where Action == \"Allow\"\n| where Direction == \"Inbound\"\n| project\n    TimeGenerated,\n    Subject,\n    SenderAddress,\n    SenderDomain,\n    SenderIP,\n    RecipientAddress,\n    ThreatVerdict,\n    ThreatConfidence,\n    SPFResult,\n    DKIMResult,\n    DMARCResult,\n    Urls,\n    AttachmentName,\n    AttachmentSHA256\n| extend\n    AccountUpn = RecipientAddress,\n    RecipientEmailAddress = RecipientAddress,\n    RemoteIP = SenderIP,\n    FileName = AttachmentName,\n    SHA256 = AttachmentSHA256,\n    RemoteUrl = tostring(parse_json(Urls)[0]),\n    ReportId = tostring(hash_sha256(strcat(tostring(TimeGenerated), SenderAddress, RecipientAddress)))"
    },
    "schedule": { "period": "1H" },
    "detectionAction": {
        "alertTemplate": {
            "title": "Phishing email delivered to {{RecipientAddress}} [MailGuard]",
            "description": "A phishing or malicious email was allowed through the MailGuard SEG to an internal recipient (T1566.001 / T1566.002). SPF/DKIM/DMARC results and threat verdict are available for investigation.",
            "severity": "medium",
            "category": "InitialAccess",
            "mitreTechniques": ["T1566.001", "T1566.002"],
            "recommendedActions": "Search for the email in user mailboxes. Remove the email. Check if the user clicked any links or opened attachments. Block the sender domain.",
            "impactedAssets": [
                { "@odata.type": "#microsoft.graph.security.impactedMailboxAsset", "identifier": "recipientEmailAddress" },
                { "@odata.type": "#microsoft.graph.security.impactedUserAsset", "identifier": "accountUpn" }
            ]
        },
        "organizationalScope": null,
        "responseActions": []
    }
}
]

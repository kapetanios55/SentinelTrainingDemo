# Exercise 10 — Data Lake vs Real-Time Detection

**Rule:** `[E7] [Palo Alto] Data Lake Port Diversity Anomaly` _(the `[E7]` prefix is the deployed rule tag)_
**Deployed in:** `Artifacts/DetectionRules/rules.json`
**MITRE ATT&CK:** T1046 (Network Service Discovery)
**Difficulty:** Intermediate
**Prerequisites:** Complete [Exercise 9 — Data Lake KQL Jobs](./E09_datalake_kql_jobs.md) first (creates the `PaloAlto_ThreatSummary_KQL_CL` table used by this exercise)

---

## Objective

Understand the difference between **real-time log detection** (E8) and **data lake aggregated detection** (E10) by building a detection against pre-aggregated data. Learn when each approach is appropriate.

## Background

The Lab environment ingests Palo Alto data in two ways:

| Source | Table | Data Type | Latency |
|---|---|---|---|
| Real-time syslog | `CommonSecurityLog` | Individual firewall events | Seconds |
| Data lake KQL job | `PaloAlto_ThreatSummary_KQL_CL` | Pre-aggregated summaries | Hours (batch) |

The data lake table `PaloAlto_ThreatSummary_KQL_CL` aggregates raw firewall logs using a KQL transformation job. Each row represents a **summary of traffic between a source-destination pair**, including:

| Column | Description |
|---|---|
| `SourceIP` | Source IP address |
| `DestinationIP` | Destination IP address |
| `DistinctPorts` | Count of unique ports used |
| `TotalSessions` | Number of sessions |
| `TotalBytesSent` | Bytes sent (aggregated) |
| `TotalBytesReceived` | Bytes received (aggregated) |
| `ThreatCategories` | Palo Alto threat categories observed |
| `FirstSeen` / `LastSeen` | Time window of observations |

### Real-Time vs Data Lake — When to Use Each

| Factor | Real-Time (E8) | Data Lake (E10) |
|---|---|---|
| **Latency** | Near real-time | Hours (batch processing) |
| **Detail** | Individual events, full context | Aggregated summaries |
| **Cost** | Higher (processes every event) | Lower (pre-aggregated) |
| **Use case** | Time-critical detections | Trend analysis, anomaly detection |
| **Lookback** | Limited by log retention | Extended via data lake retention |
| **Volume** | Can be overwhelming | Compressed into summaries |

> **Key insight:** E8 (port scan) catches the scan as it happens. E10 (port diversity) catches the same pattern from aggregated data — useful for environments where real-time syslog isn’t available or for retroactive hunting.

## Techniques Covered

### Working with Pre-Aggregated Data

Unlike raw logs, the data lake table already contains computed metrics. The query is simpler because the aggregation is done upstream:

```kusto
PaloAlto_ThreatSummary_KQL_CL
| where TimeGenerated > ago(4h)
| where DistinctPorts > 10
```

Compare this to E8, which must compute `dcount(DestinationPort)` from raw events.

### Schedule Frequency for Data Lake Tables

The rule uses a **3-hour schedule** instead of the standard 1-hour. This accounts for:

1. Data lake batch processing delay (data arrives in chunks)
2. The lookback window is 12 hours (4× frequency)
3. Overlapping windows ensure no data is missed between batches

```json
"schedule": { "period": "3H" }
```

## Steps

### Step 1 — Compare the Two Approaches

Run both queries side-by-side in Advanced Hunting:

**E8 (Real-time):**
```kusto
CommonSecurityLog
| where TimeGenerated > ago(4h)
| where DeviceVendor == "Palo Alto Networks"
| where Activity in ("drop", "deny", "reset-both")
| summarize DistinctPorts = dcount(DestinationPort) by SourceIP, DestinationIP
| where DistinctPorts > 10
| project SourceIP, DestinationIP, DistinctPorts, Source = "RealTime"
```

**E10 (Data lake):**
```kusto
PaloAlto_ThreatSummary_KQL_CL
| where TimeGenerated > ago(4h)
| where DistinctPorts > 10
| project SourceIP, DestinationIP, DistinctPorts, Source = "DataLake"
```

Questions to consider:
- Do both queries return the same source-destination pairs?
- Are the `DistinctPorts` counts similar?
- What additional context does each provide?

### Step 2 — Examine the Data Lake Schema

Explore what the aggregated table provides that raw logs don't:

```kusto
PaloAlto_ThreatSummary_KQL_CL
| take 5
| project-away TenantId, _ResourceId
```

Note the `ThreatCategories` column — this is a pre-computed set of threat categories that would require a complex `make_set()` aggregation against raw logs.

### Step 3 — Adjust the Threshold

The E10 threshold (`DistinctPorts > 10`) is lower than E8 (`> 20`) because data lake aggregation covers a wider time window. Try adjusting:

```kusto
// Strict: only flag egregious diversity
| where DistinctPorts > 25 and TotalSessions > 100

// Permissive: catch subtle scanning
| where DistinctPorts > 5 and TotalBytesSent < 10000
```

The second filter adds a bytes constraint — low bytes + many ports = scanning, not legitimate traffic.

### Step 4 — Enable and Compare Alerts

1. Enable both E8 and E10
2. Run an attack simulation using `.\Scripts\IngestCSV.ps1`
3. Compare the alerts generated by each rule:
   - Which fired first?
   - Which provided more context?
   - Which had fewer false positives?

## Key Takeaways

- Data lake detection trades **latency for efficiency** — use it for trend analysis and anomaly detection
- Pre-aggregated data simplifies queries but loses individual event detail
- Schedule frequency must align with data lake batch processing intervals
- Both approaches can coexist — real-time catches urgent threats, data lake catches patterns
- The `ThreatCategories` enrichment from data lake provides threat context unavailable in raw logs

## Microsoft Learn References

- [Advanced hunting best practices](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-best-practices)
- [Custom detection rule frequency](https://learn.microsoft.com/en-us/defender-xdr/custom-detection-rules#create-a-custom-detection-rule)
- [MITRE T1046 — Network Service Discovery](https://attack.mitre.org/techniques/T1046/)
